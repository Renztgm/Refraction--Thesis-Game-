name: CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download Godot 4.5 headless
      run: |
        wget https://github.com/godotengine/godot/releases/download/4.5-stable/Godot_v4.5-stable_linux.x86_64.zip -O godot.zip
        unzip godot.zip -d $HOME/godot
        mv $HOME/godot/Godot_v4.5-stable_linux.x86_64 $HOME/godot/godot
        chmod +x $HOME/godot/godot
    
    - name: Import Godot project
      run: |
        $HOME/godot/godot --headless --path . --editor --quit --verbose

    - name: Run GUT Tests
      run: |
        mkdir -p test_results logs
        timeout 120 $HOME/godot/godot --headless --path . \
          -s test_runner.gd \
          2>&1 | tee logs/tests_full.log || true

    - name: Generate Test Summary
      if: always()
      run: |
        # Strip ANSI color codes
        sed 's/\x1b\[[0-9;]*m//g' logs/tests_full.log > logs/tests_clean.log
        
        # Extract metrics
        SCRIPTS=$(grep -oP "Scripts\s+\K\d+" logs/tests_clean.log || echo "0")
        TOTAL_TESTS=$(grep -oP "Tests\s+\K\d+" logs/tests_clean.log || echo "0")
        PASSING=$(grep -oP "Passing\s+\K\d+" logs/tests_clean.log || echo "0")
        ASSERTS=$(grep -oP "Asserts\s+\K\d+" logs/tests_clean.log || echo "0")
        TIME=$(grep -oP "Time\s+\K[\d.]+s" logs/tests_clean.log || echo "0s")
        WARNINGS=$(grep -oP "Warnings\s+\K\d+" logs/tests_clean.log || echo "0")
        
        # Check if all tests passed
        if grep -q "All tests passed" logs/tests_clean.log; then
          STATUS="âœ… All Tests Passed!"
          STATUS_COLOR="ðŸŸ¢"
          EXIT_CODE=0
        else
          STATUS="âŒ Tests Failed"
          STATUS_COLOR="ðŸ”´"
          EXIT_CODE=1
        fi
        
        # Create beautiful GitHub summary
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # ðŸ“ GUT Test Results
        
        ## $STATUS_COLOR $STATUS
        
        | Metric | Count |
        |--------|-------|
        | ðŸ“„ Scripts | $SCRIPTS |
        | ðŸ“ Tests | $TOTAL_TESTS |
        | âœ… Passing | $PASSING |
        | ðŸ” Assertions | $ASSERTS |
        | â±ï¸ Time | $TIME |
        | âš ï¸ Warnings | $WARNINGS |
        
        <details>
        <summary>ðŸ“‹ Full Test Output</summary>
        
        \`\`\`
        $(grep -A 30 "= Run Summary" logs/tests_clean.log || echo "No summary found")
        \`\`\`
        
        </details>
        EOF
        
        echo "Test Status: $STATUS"
        exit $EXIT_CODE

    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: logs/
