name: CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download Godot 4.5 headless
      run: |
        wget https://github.com/godotengine/godot/releases/download/4.5-stable/Godot_v4.5-stable_linux.x86_64.zip -O godot.zip
        unzip godot.zip -d $HOME/godot
        mv $HOME/godot/Godot_v4.5-stable_linux.x86_64 $HOME/godot/godot
        chmod +x $HOME/godot/godot
    
    - name: Import Godot project
      run: |
        $HOME/godot/godot --headless --path . --editor --quit --verbose

    - name: Run GUT Tests
      run: |
        mkdir -p test_results logs
        timeout 120 $HOME/godot/godot --headless --path . \
          -s test_runner.gd \
          2>&1 | tee logs/tests_full.log || true

    - name: Generate Test Summary
      if: always()
      run: |
        # Strip ANSI color codes
        sed 's/\x1b\[[0-9;]*m//g' logs/tests_full.log > logs/tests_clean.log
        
        # Extract metrics from summary section
        SCRIPTS=$(grep -oP "Scripts\s+\K\d+" logs/tests_clean.log | head -1 || echo "0")
        TOTAL_TESTS=$(grep -oP "Tests\s+\K\d+" logs/tests_clean.log | head -1 || echo "0")
        PASSING=$(grep -oP "Passing\s+\K\d+" logs/tests_clean.log | head -1 || echo "0")
        ASSERTS=$(grep -oP "Asserts\s+\K\d+" logs/tests_clean.log | head -1 || echo "0")
        TIME=$(grep -oP "Time\s+\K[\d.]+s" logs/tests_clean.log | head -1 || echo "0s")
        WARNINGS=$(grep -oP "Warnings\s+\K\d+" logs/tests_clean.log | head -1 || echo "0")
        
        # Check if all tests passed
        if grep -q "All tests passed" logs/tests_clean.log; then
          STATUS="‚úÖ All Tests Passed!"
          STATUS_COLOR="üü¢"
          EXIT_CODE=0
        else
          STATUS="‚ùå Tests Failed"
          STATUS_COLOR="üî¥"
          EXIT_CODE=1
        fi
        
        # Extract test files from the actual test execution output
        # Look for lines like "res://tests/test_*.gd"
        TEST_FILES_TABLE=""
        
        # Parse each test script section
        while IFS= read -r line; do
          if [[ $line =~ res://tests/(test_[^[:space:]]+\.gd) ]]; then
            filename="${BASH_REMATCH[1]}"
            
            # Check if already processed
            if [[ ! "$TEST_FILES_TABLE" =~ "$filename" ]]; then
              # Look ahead in the log to see if this file had failures
              if grep -A 20 "res://tests/$filename" logs/tests_clean.log | grep -q "Failing"; then
                TEST_FILES_TABLE="$TEST_FILES_TABLE| ‚ùå | \`$filename\` | Failed |\n"
              else
                TEST_FILES_TABLE="$TEST_FILES_TABLE| ‚úÖ | \`$filename\` | All passed |\n"
              fi
            fi
          fi
        done < logs/tests_clean.log
        
        # If no test files found, list files from directory
        if [ -z "$TEST_FILES_TABLE" ]; then
          for file in tests/test_*.gd; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              TEST_FILES_TABLE="$TEST_FILES_TABLE| ‚úÖ | \`$filename\` | All passed |\n"
            fi
          done
        fi
        
        # Create beautiful GitHub summary
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # üìù GUT Test Results
        
        ## $STATUS_COLOR $STATUS
        
        ### üìä Test Metrics
        
        | Metric | Count |
        |--------|-------|
        | üìÑ Scripts | $SCRIPTS |
        | üìù Tests | $TOTAL_TESTS |
        | ‚úÖ Passing | $PASSING |
        | üîç Assertions | $ASSERTS |
        | ‚è±Ô∏è Time | $TIME |
        | ‚ö†Ô∏è Warnings | $WARNINGS |
        
        ### üìÅ Test Files
        
        | Status | File | Result |
        |--------|------|--------|
        $(echo -e "$TEST_FILES_TABLE")
        
        <details>
        <summary>üìã Full Test Output</summary>
        
        \`\`\`
        $(cat logs/tests_clean.log | tail -200)
        \`\`\`
        
        </details>
        EOF
        
        echo "Test Status: $STATUS"
        echo "Scripts: $SCRIPTS, Tests: $TOTAL_TESTS, Passing: $PASSING"
        exit $EXIT_CODE

    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: logs/