name: CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download Godot 4.5 headless
      run: |
        wget https://github.com/godotengine/godot/releases/download/4.5-stable/Godot_v4.5-stable_linux.x86_64.zip -O godot.zip
        unzip godot.zip -d $HOME/godot
        mv $HOME/godot/Godot_v4.5-stable_linux.x86_64 $HOME/godot/godot
        chmod +x $HOME/godot/godot
    
    - name: Import Godot project
      run: |
        $HOME/godot/godot --headless --path . --editor --quit --verbose

    - name: Run GUT Tests
      run: |
        mkdir -p test_results logs
        timeout 120 $HOME/godot/godot --headless --path . \
          -s test_runner.gd \
          2>&1 | tee logs/tests_full.log || true

    - name: Generate Test Summary
      if: always()
      run: |
        # Strip ANSI color codes
        sed 's/\x1b\[[0-9;]*m//g' logs/tests_full.log > logs/tests_clean.log
        
        # Extract metrics
        SCRIPTS=$(grep -oP "Scripts\s+\K\d+" logs/tests_clean.log || echo "0")
        TOTAL_TESTS=$(grep -oP "Tests\s+\K\d+" logs/tests_clean.log || echo "0")
        PASSING=$(grep -oP "Passing\s+\K\d+" logs/tests_clean.log || echo "0")
        ASSERTS=$(grep -oP "Asserts\s+\K\d+" logs/tests_clean.log || echo "0")
        TIME=$(grep -oP "Time\s+\K[\d.]+s" logs/tests_clean.log || echo "0s")
        WARNINGS=$(grep -oP "Warnings\s+\K\d+" logs/tests_clean.log || echo "0")
        
        # Check if all tests passed
        if grep -q "All tests passed" logs/tests_clean.log; then
          STATUS="‚úÖ All Tests Passed!"
          STATUS_COLOR="üü¢"
          EXIT_CODE=0
        else
          STATUS="‚ùå Tests Failed"
          STATUS_COLOR="üî¥"
          EXIT_CODE=1
        fi
        
        # Extract test file results
        TEST_FILES=$(grep -E "res://tests/test_.*\.gd" logs/tests_clean.log | grep -oP "res://tests/\K[^:]*" | sort -u || echo "")
        
        # Build test files table
        TEST_FILES_TABLE=""
        if [ ! -z "$TEST_FILES" ]; then
          while IFS= read -r file; do
            # Check if this file had any failures
            if grep -q "$file" logs/tests_clean.log && ! grep "$file" logs/tests_clean.log | grep -q "Failed"; then
              TEST_FILES_TABLE="$TEST_FILES_TABLE| ‚úÖ | \`$file\` | All passed |\n"
            else
              TEST_FILES_TABLE="$TEST_FILES_TABLE| ‚ùå | \`$file\` | Failed |\n"
            fi
          done <<< "$TEST_FILES"
        fi
        
        # Create beautiful GitHub summary
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # üìù GUT Test Results
        
        ## $STATUS_COLOR $STATUS
        
        ### üìä Test Metrics
        
        | Metric | Count |
        |--------|-------|
        | üìÑ Scripts | $SCRIPTS |
        | üìù Tests | $TOTAL_TESTS |
        | ‚úÖ Passing | $PASSING |
        | üîç Assertions | $ASSERTS |
        | ‚è±Ô∏è Time | $TIME |
        | ‚ö†Ô∏è Warnings | $WARNINGS |
        
        ### üìÅ Test Files
        
        | Status | File | Result |
        |--------|------|--------|
        $(echo -e "$TEST_FILES_TABLE")
        
        <details>
        <summary>üìã Full Test Output</summary>
        
        \`\`\`
        $(grep -A 50 "= Run Summary" logs/tests_clean.log || cat logs/tests_clean.log | tail -100)
        \`\`\`
        
        </details>
        EOF
        
        echo "Test Status: $STATUS"
        exit $EXIT_CODE

    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: logs/